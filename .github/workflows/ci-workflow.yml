name: Build XIVLauncher
on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
        with:
            submodules: recursive

      # https://github.com/dotnet/msbuild/issues/4332#issuecomment-485923582
      - uses: microsoft/setup-msbuild@v1

      - uses: actions/cache@v2
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget

      - name: Define VERSION
        run: |
          $env:COMMIT = $env:GITHUB_SHA.Substring(0, 7)
          $env:REPO_NAME = $env:GITHUB_REPOSITORY -replace '.*/'
          $env:BRANCH = $env:GITHUB_REF -replace '.*/'

          ($env:REPO_NAME) >> VERSION
          ($env:BRANCH) >> VERSION
          ($env:COMMIT) >> VERSION

      - name: Restore Nuget Packages
        run: dotnet restore
      
      - name: Build
        run: msbuild -m -target:Publish -p:SelfContained=false -p:Configuration=ReleaseNoUpdate -p:PublishDir=${{ github.workspace }}/bin

      - name: Upload artifact
        uses: actions/upload-artifact@master
        with:
          name: xivlauncher-artifact
          path: bin\
          retention-days: 14
